# 揭棋 FEN 格式规范 (JFN v2)

## 设计目标

1. **字符串接口**：输入输出都用字符串，接口干净
2. **完整信息**：FEN 包含棋盘状态 + 被吃子信息
3. **玩家视角**：正确处理信息不对称（暗子身份）

## 格式概览

```
<棋盘> <被吃子> <回合> <视角>
```

示例（初始局面，将帅已揭）：
```
xxxxkxxxx/9/1x5x1/x1x1x1x1x/9/9/X1X1X1X1X/1X5X1/9/XXXXKXXXX -:- r r
```

---

## 1. 棋盘部分

从 row 9 到 row 0（黑方底线到红方底线），每行用 `/` 分隔。

### 符号表

| 类型 | 红方 | 黑方 | 说明 |
|------|------|------|------|
| 将/帅 | `K` | `k` | King |
| 车 | `R` | `r` | Rook |
| 马 | `H` | `h` | Horse |
| 炮 | `C` | `c` | Cannon |
| 象 | `E` | `e` | Elephant |
| 士 | `A` | `a` | Advisor |
| 兵/卒 | `P` | `p` | Pawn |
| **暗子** | `X` | `x` | 身份未知 |
| 空格 | 数字 1-9 | | 连续空格数 |

### 示例

初始局面（将帅已揭）：
```
xxxxkxxxx/9/1x5x1/x1x1x1x1x/9/9/X1X1X1X1X/1X5X1/9/XXXXKXXXX
```

混合局面（部分明子）：
```
4k4/9/1c7/9/9/9/9/9/9/X3K4
```

---

## 2. 被吃子部分

格式：`红方被吃:黑方被吃`

### 符号规则

**重要：位置决定颜色，大小写决定明/暗**

- 冒号左边 = 红方被吃（红子）
- 冒号右边 = 黑方被吃（黑子）
- 大小写只表示被吃时是明子还是暗子，不表示颜色

| 符号 | 含义 | 示例 |
|------|------|------|
| 大写 | 明子被吃 | `E` 在右边 = 黑方的明象被吃 |
| 小写 | 暗子被吃，吃的人知道身份 | `e` 在右边 = 黑方的暗象被吃 |
| `?` | 暗子被吃，我不知道身份 | 对方吃的我的暗子 |
| `-` | 无被吃子 | |

### 信息规则

| 场景 | 显示 |
|------|------|
| 我方明子被吃 | 大写（双方都知道） |
| 我方暗子被吃 | `?`（我不知道） |
| 对方明子被我吃 | 大写（双方都知道） |
| 对方暗子被我吃 | 小写（只有我知道） |

### 示例

红方视角：
```
RP??:raHC
```
解读：
- 红方被吃：`R`(明子车) `P`(明子兵) `??`(两个暗子，不知道是什么)
- 黑方被吃：`r`(暗子车) `a`(暗子士) `H`(明子马) `C`(明子炮)

同一局，黑方视角：
```
RPha:??HC
```
解读：
- 红方被吃：`R`(明子车) `P`(明子兵) `h`(暗子马) `a`(暗子士) - 黑方吃的，全知道
- 黑方被吃：`??`(两个暗子，不知道) `H`(明子马) `C`(明子炮)

---

## 3. 回合和视角

| 字段 | 含义 | 值 |
|------|------|------|
| 回合 | 当前该谁走 | `r`=红方, `b`=黑方 |
| 视角 | FEN 从谁的视角生成 | `r`=红方, `b`=黑方 |

---

## 4. 走法格式

### 基本格式

```
<起点><终点>
```

坐标使用列字母(a-i) + 行数字(0-9)。

### 走法类型

| 格式 | 类型 | 说明 |
|------|------|------|
| `a0a1` | 明子走法 | 从 a0 走到 a1 |
| `+a0a1` | 揭子走法 | 暗子揭开并走到 a1 |
| `+a0a1=R` | 揭子结果 | 揭出了车（执行后） |

### 坐标系

```
  a b c d e f g h i
9 · · · · k · · · ·  ← 黑方底线
8 · · · · · · · · ·
7 · c · · · · · c ·
6 p · p · p · p · p
5 · · · · · · · · ·
4 · · · · · · · · ·
3 P · P · P · P · P
2 · C · · · · · C ·
1 · · · · · · · · ·
0 R H E A K A E H R  ← 红方底线
```

---

## 5. 完整示例

### 初始局面（将帅已揭）

```
xxxxkxxxx/9/1x5x1/x1x1x1x1x/9/9/X1X1X1X1X/1X5X1/9/XXXXKXXXX -:- r r
```

### 中局（红方视角）

```
4k4/9/3R5/x1x3x1x/4X4/4x4/X1X3X1X/1C5C1/9/4K4 RP??:raHC r r
```

### AI 接口使用

```python
def select_moves(fen: str, n: int = 10) -> list[tuple[str, float]]:
    """
    输入: FEN 字符串
    输出: [(走法, 评分), ...] top-n
    """
    # AI 返回示例
    return [
        ("a0a1", 0.85),    # 明子走法
        ("+e3e4", 0.72),   # 揭子走法
        ("b2h2", 0.68),
    ]
```

执行揭子走法后，游戏引擎返回带结果的走法：
```python
executed_move = "+e3e4=C"  # 揭出了炮
```

---

## 6. 验证规则

FEN 验证时需检查以下规则：

### 暗子位置约束

暗子只能出现在初始位置：

**红方暗子 (X) 有效位置：**
- Row 0: 全部 (a0-i0)
- Row 2: b2, h2
- Row 3: a3, c3, e3, g3, i3

**黑方暗子 (x) 有效位置：**
- Row 9: 全部 (a9-i9)
- Row 7: b7, h7
- Row 6: a6, c6, e6, g6, i6

### 棋子数量限制

| 类型 | 每方最多 |
|------|----------|
| 将/帅 (K/k) | 1 |
| 车 (R/r) | 2 |
| 马 (H/h) | 2 |
| 炮 (C/c) | 2 |
| 象 (E/e) | 2 |
| 士 (A/a) | 2 |
| 兵/卒 (P/p) | 5 |

### 总数约束

- 每方总棋子（棋盘上 + 被吃）≤ 16
- 全局总棋子（棋盘上 + 被吃）≤ 32

---

## 7. 实现文件

### Python
- `jieqi/fen.py` - FEN 生成和解析
- `jieqi/fen_test.py` - 测试用例

### Rust
- `rust-ai/src/fen.rs` - FEN 解析和生成（AI 内部使用）
- `rust-ai/src/types.rs` - 棋子类型定义

### 核心函数

```python
# 从 PlayerView 生成 FEN
def to_fen(view: PlayerView) -> str

# 解析 FEN 字符串
def parse_fen(fen: str) -> FenState

# 走法转字符串
def move_to_str(move: JieqiMove, revealed_type: PieceType | None = None) -> str

# 解析走法字符串
def parse_move(move_str: str) -> tuple[JieqiMove, PieceType | None]
```
